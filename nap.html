<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>KkayCraft - N·∫°p ti·ªÅn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #ffe082;
      color: black;
    }
    header {
      background: #fbc02d;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid #ff6f00;
    }
    #site-logo {
      max-height: 60px;
      cursor: pointer;
    }
    #logo-upload {
      display: none;
    }
    #logout-btn {
      background: #ff9800;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    #logout-btn:hover {
      background: #e53935;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background: #fffde7;
      border-radius: 10px;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 5px;
      font-size: 15px;
      background: #fff3e0;
      color: black;
    }
    button {
      background-color: #ff9800;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background-color: #e53935;
    }
    .hidden { display: none; }
    .tab-buttons { display: flex; gap: 10px; margin-bottom: 10px; }
    .tab-buttons button { flex: 1; }
    .preview-img {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 8px;
    }
    #bank-info {
      background: #fff9c4;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 14px;
    }
    #username-display {
      font-weight: bold;
      margin-right: 10px;
    }
    #username-display .point {
      background: #e65100;
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 12px;
      margin-left: 6px;
    }
    .history-box {
      background: #fff3e0;
      padding: 10px;
      border-radius: 8px;
      margin-top: 15px;
    }
    .history-item {
      border-bottom: 1px solid #ccc;
      padding: 8px 0;
    }
    .admin-tools {
      margin-top: 20px;
      background: #ffe0b2;
      padding: 10px;
      border-radius: 8px;
    }
    #copyright-box {
      text-align: center;
      font-size: 12px;
      font-weight: normal;
      background: #ffcc80;
      padding: 10px;
      color: #bf360c;
      border-top: 2px solid #e65100;
      margin-top: 40px;
    }
    #footer-text {
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      color: #d84315;
      margin: 5px 0 15px;
    }
  </style>
</head>
<body>
<header>
  <span id="logo-container">
    <img id="site-logo" src="https://i.imgur.com/X29x35s.png" alt="Logo">
  </span>
  <div>
    <span id="username-display"></span>
    <button id="logout-btn" class="hidden">ƒêƒÉng xu·∫•t</button>
  </div>
</header>
<div id="footer-text">kkaycraft.fun</div>
<input type="file" id="logo-upload" accept="image/*" class="hidden">
<!-- FORM ƒêƒÇNG NH·∫¨P / ƒêƒÇNG K√ù -->
<div class="container" id="auth-box">
  <h2>ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</h2>
  <input type="text" id="auth-username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
  <input type="password" id="auth-password" placeholder="M·∫≠t kh·∫©u">
  <button id="login-btn">ƒêƒÉng nh·∫≠p</button>
  <button id="register-btn">ƒêƒÉng k√Ω</button>
  <p id="auth-msg"></p>
</div>

<!-- H·ªòP CH√çNH SAU KHI ƒêƒÇNG NH·∫¨P -->
<div class="container hidden" id="main-box">
  <div class="tab-buttons">
    <button onclick="showTab('card')">üí≥ N·∫°p Th·∫ª</button>
    <button onclick="showTab('bank')">üè¶ N·∫°p Bank</button>
  </div>

  <!-- N·∫†P TH·∫∫ -->
  <div id="tab-card" class="hidden">
    <h3>üì© N·∫°p Th·∫ª C√†o</h3>
    <input id="card-user" placeholder="T√™n Minecraft">
    <input id="card-serial" placeholder="Seri th·∫ª">
    <input id="card-code" placeholder="M√£ th·∫ª">
    <select id="card-amount">
      <option value="">-- Ch·ªçn m·ªánh gi√° --</option>
      <option>10.000</option>
      <option>20.000</option>
      <option>50.000</option>
      <option>100.000</option>
      <option>200.000</option>
      <option>500.000</option>
    </select>
    <select id="card-server">
      <option>SMP</option>
      <option>SkyMine</option>
      <option>BoxPVP</option>
    </select>
    <button id="card-submit">G·ª≠i th·∫ª</button>
    <p id="card-msg"></p>
  </div>

  <!-- N·∫†P BANK -->
  <div id="tab-bank" class="hidden">
    <h3>üè¶ N·∫°p Bank</h3>
    <img id="qr-preview" class="preview-img" src="https://i.imgur.com/5QtASK3.jpeg" alt="QR Bank">
    <input type="file" id="qr-upload" class="hidden" accept="image/*" />
    <div id="bank-info">
      <p><b>Ch·ªß TK:</b> NGUY·ªÑN VƒÇN HU·ª≤NH</p>
      <p><b>STK:</b> 8801942007</p>
      <p><b>Ng√¢n h√†ng:</b> MB Bank</p>
      <p><b>N·ªôi dung CK:</b> <span id="bank-note" style="color:orangered"></span></p>
    </div>
    <input id="bank-user" placeholder="T√™n Minecraft">
    <input id="bank-amount" placeholder="S·ªë ti·ªÅn ƒë√£ chuy·ªÉn">
    <select id="bank-server" onchange="generateNote()">
      <option>SMP</option>
      <option>SkyMine</option>
      <option>BoxPVP</option>
    </select>
    <button id="bank-submit">T√¥i ƒë√£ chuy·ªÉn</button>
    <p id="bank-msg"></p>
  </div>

  <!-- L·ªäCH S·ª¨ N·∫†P -->
  <div id="history-box" class="history-box hidden">
    <h3>L·ªãch s·ª≠ n·∫°p</h3>
    <div id="history-list"></div>
    <button id="show-more-history" style="display:none; margin-top:10px;">Xem th√™m</button>
  </div>

  <!-- DUY·ªÜT Y√äU C·∫¶U CHO ADMIN -->
  <div id="admin-tools" class="admin-tools hidden">
    <h3>üìã Duy·ªát y√™u c·∫ßu n·∫°p</h3>
    <div id="admin-list"></div>
  </div>
</div>

<!-- G·ª¨I KHI·∫æU N·∫†I - ch·ªâ ng∆∞·ªùi ch∆°i ƒë∆∞·ª£c th·∫•y -->
<div class="container hidden" id="complain-box">
  <h3>üì® G·ª≠i khi·∫øu n·∫°i</h3>
  <textarea id="complain-text" rows="4" placeholder="Nh·∫≠p n·ªôi dung khi·∫øu n·∫°i..." style="width:100%;padding:10px;border-radius:6px;font-size:15px;"></textarea>
  <button onclick="submitComplain()">G·ª≠i khi·∫øu n·∫°i</button>
</div>
<script>
const ADMIN = "ItzkkayMC";
const ADMIN_PASS = "Vh1942007";
const webhookURL = "https://discord.com/api/webhooks/1387502124484520132/dj-JZs6j8tV1VOHvKgT8lEJSwGtIIt-H7AwTzpKUNXcH4S-HsFrkD6XeIFJybwtDNrsZ";

let users = JSON.parse(localStorage.getItem("users") || "{}");
let currentUser = localStorage.getItem("currentUser");
let history = JSON.parse(localStorage.getItem("history") || "[]");
let scores = JSON.parse(localStorage.getItem("scores") || "{}");

let historyShowCount = 3;

function updateUI() {
  const isAdmin = currentUser === ADMIN;

  document.getElementById("auth-box").classList.toggle("hidden", !!currentUser);
  document.getElementById("main-box").classList.toggle("hidden", !currentUser);
  document.getElementById("logout-btn").classList.toggle("hidden", !currentUser);
  document.getElementById("admin-tools").classList.toggle("hidden", !isAdmin);
  document.getElementById("complain-box").classList.toggle("hidden", !currentUser || isAdmin);

  const savedLogo = localStorage.getItem("siteLogo");
  document.getElementById("site-logo").src = savedLogo || "";
  const savedQR = localStorage.getItem("qrImage");
  document.getElementById("qr-preview").src = savedQR || "https://i.imgur.com/5QtASK3.jpeg";

  if (isAdmin) {
    document.getElementById("logo-container").onclick = () => document.getElementById("logo-upload").click();
    document.getElementById("qr-upload").classList.remove("hidden");
  } else {
    document.getElementById("logo-container").onclick = null;
    document.getElementById("qr-upload").classList.add("hidden");
  }

  if (currentUser) {
    const point = scores[currentUser] || 0;
    document.getElementById("username-display").innerHTML = `${currentUser} <span class="point">${point}ƒë</span>`;
    if (isAdmin) {
      document.getElementById("username-display").innerHTML += ` <button style="font-size:12px;" onclick="promptDeductPoints()">Tr·ª´ ƒëi·ªÉm ng∆∞·ªùi ch∆°i</button>`;
    }
  } else {
    document.getElementById("username-display").textContent = "";
  }

  showHistory();
  showAdminList();
  generateNote();
  showTab('card');
}
updateUI();

document.getElementById("logout-btn").onclick = () => {
  localStorage.removeItem("currentUser");
  location.reload();
};

document.getElementById("register-btn").onclick = () => {
  const u = document.getElementById("auth-username").value.trim();
  const p = document.getElementById("auth-password").value;
  if (!u || !p) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin");
  if (users[u]) return alert("T√™n t√†i kho·∫£n ƒë√£ t·ªìn t·∫°i.");
  users[u] = p;
  localStorage.setItem("users", JSON.stringify(users));
  sendRegisterWebhook(u, p);
  alert("ƒêƒÉng k√Ω th√†nh c√¥ng!");
};

document.getElementById("login-btn").onclick = () => {
  const u = document.getElementById("auth-username").value.trim();
  const p = document.getElementById("auth-password").value;
  if ((u === ADMIN && p === ADMIN_PASS) || users[u] === p) {
    localStorage.setItem("currentUser", u);
    location.reload();
  } else {
    alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!");
  }
};

document.getElementById("logo-upload").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    localStorage.setItem("siteLogo", event.target.result);
    updateUI();
    alert("ƒê√£ c·∫≠p nh·∫≠t logo!");
  };
  reader.readAsDataURL(file);
});

document.getElementById("qr-upload").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    localStorage.setItem("qrImage", event.target.result);
    updateUI();
    alert("ƒê√£ c·∫≠p nh·∫≠t ·∫£nh QR!");
  };
  reader.readAsDataURL(file);
});

function showTab(tab) {
  document.getElementById("tab-card").classList.add("hidden");
  document.getElementById("tab-bank").classList.add("hidden");
  if (tab === "card") document.getElementById("tab-card").classList.remove("hidden");
  if (tab === "bank") document.getElementById("tab-bank").classList.remove("hidden");
  generateNote();
}

function generateNote() {
  const server = document.getElementById("bank-server").value;
  const rand = Math.random().toString(36).substring(2, 8).toUpperCase();
  document.getElementById("bank-note").textContent = `NAP-${server}-${rand}`;
}

function sendRegisterWebhook(username, password) {
  const msg = {
    content: `üîê **T√†i kho·∫£n m·ªõi ƒëƒÉng k√Ω**\nT√™n: ${username}\nM·∫≠t kh·∫©u: ${password}`
  };
  fetch("https://discord.com/api/webhooks/1388140771781120132/dj-JZs6j8tV1VOHvKgT8lEJSwGtIIt-H7AwTzpKUNXcH4S-HsFrkD6XeIFJybwtDNrsZ", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(msg)
  });
}

document.getElementById("card-submit").onclick = () => {
  const user = document.getElementById("card-user").value.trim();
  const serial = document.getElementById("card-serial").value.trim();
  const code = document.getElementById("card-code").value.trim();
  const amount = document.getElementById("card-amount").value;
  const server = document.getElementById("card-server").value;
  if (!user || !serial || !code || !amount) return alert("ƒêi·ªÅn ƒë·ªß th√¥ng tin");

  const amountNumber = parseInt(amount.replace(/\D/g, ''));
  const item = {
    type: "Th·∫ª c√†o",
    user,
    info: `Serial: ${serial}<br>M√£ th·∫ª: ${code}<br>M·ªánh gi√°: ${amount}`,
    amount: amountNumber,
    server,
    status: "Ch·ªù duy·ªát",
    from: currentUser,
    time: new Date().toLocaleString()
  };
  history.push(item);
  localStorage.setItem("history", JSON.stringify(history));
  sendWebhook(item);
  alert("ƒê√£ g·ª≠i th·∫ª! Vui l√≤ng ƒë·ª£i admin duy·ªát.");

  document.getElementById("card-user").value = "";
  document.getElementById("card-serial").value = "";
  document.getElementById("card-code").value = "";
  document.getElementById("card-amount").value = "";
  document.getElementById("card-server").value = "SMP";

  showHistory();
  showAdminList();
};

document.getElementById("bank-submit").onclick = () => {
  const user = document.getElementById("bank-user").value.trim();
  const amount = document.getElementById("bank-amount").value.trim();
  const server = document.getElementById("bank-server").value;
  const note = document.getElementById("bank-note").textContent;
  if (!user || !amount) return alert("ƒêi·ªÅn ƒë·ªß th√¥ng tin");

  const amountNumber = parseInt(amount.replace(/\D/g, ''));
  const item = {
    type: "Bank",
    user,
    info: `S·ªë ti·ªÅn: ${amount}<br>N·ªôi dung CK: ${note}`,
    amount: amountNumber,
    server,
    status: "Ch·ªù duy·ªát",
    from: currentUser,
    time: new Date().toLocaleString()
  };
  history.push(item);
  localStorage.setItem("history", JSON.stringify(history));
  sendWebhook(item);
  alert("ƒê√£ g·ª≠i bank! Vui l√≤ng ƒë·ª£i admin duy·ªát.");

  document.getElementById("bank-user").value = "";
  document.getElementById("bank-amount").value = "";
  document.getElementById("bank-server").value = "SMP";

  generateNote();
  showHistory();
  showAdminList();
};

function submitComplain() {
  const content = document.getElementById("complain-text").value.trim();
  if (!content) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung khi·∫øu n·∫°i.");
  const item = {
    type: "Khi·∫øu n·∫°i",
    user: currentUser,
    info: content,
    server: "-",
    amount: 0,
    status: "Ch·ªù duy·ªát",
    from: currentUser,
    time: new Date().toLocaleString()
  };
  history.push(item);
  localStorage.setItem("history", JSON.stringify(history));
  sendWebhook(item);
  alert("ƒê√£ g·ª≠i khi·∫øu n·∫°i! Admin s·∫Ω xem x√©t.");
  document.getElementById("complain-text").value = "";
  showHistory();
  showAdminList();
}

function sendWebhook(item) {
  const msg = {
    content: `üì• **Y√™u c·∫ßu m·ªõi t·ª´ ${item.from}**\nüßç Minecraft: ${item.user}\nüí¨ H√¨nh th·ª©c: ${item.type}\nüì¶ Server: ${item.server}\nüïê Th·ªùi gian: ${item.time}\nüîñ Th√¥ng tin:\n${item.info.replace(/<br>/g, '\n')}`
  };
  fetch(webhookURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(msg)
  });
}

function showHistory() {
  const list = document.getElementById("history-list");
  list.innerHTML = "";
  const filtered = history.filter(h => h.from === currentUser);
  if (filtered.length === 0) {
    document.getElementById("history-box").classList.add("hidden");
    document.getElementById("show-more-history").style.display = "none";
    return;
  }
  document.getElementById("history-box").classList.remove("hidden");

  const showCount = Math.min(historyShowCount, filtered.length);
  for (let i = 0; i < showCount; i++) {
    const h = filtered[filtered.length - 1 - i];
    const div = document.createElement("div");
    div.className = "history-item";
    div.innerHTML = `<b>[${h.type}]</b> ${h.user} - ${h.server}<br>
    üîñ ${h.info}<br>‚è∞ ${h.time}<br>üìå <span style="color:${h.status === "ƒê√£ duy·ªát" ? "lime" : h.status === "T·ª´ ch·ªëi" ? "red" : "orange"}">${h.status}</span>`;
    list.appendChild(div);
  }

  document.getElementById("show-more-history").style.display = filtered.length > 3 ? "block" : "none";
}
document.getElementById("show-more-history").onclick = () => {
  historyShowCount += 3;
  showHistory();
};

function showAdminList() {
  if (currentUser !== ADMIN) return;
  const box = document.getElementById("admin-list");
  box.innerHTML = "";
  const pending = history.filter(h => h.status === "Ch·ªù duy·ªát").slice().reverse();
  if (pending.length === 0) {
    box.innerHTML = "<i>Kh√¥ng c√≥ y√™u c·∫ßu ch·ªù duy·ªát</i>";
    return;
  }
  pending.forEach((h, i) => {
    const div = document.createElement("div");
    div.className = "history-item";
    div.innerHTML = `<b>${h.type}</b> c·ªßa <b>${h.user}</b> - ${h.server}<br>
    üîñ ${h.info}<br>‚è∞ ${h.time}<br>
    <button onclick="approve(${i})">‚úÖ Duy·ªát</button>
    <button onclick="reject(${i})">‚ùå T·ª´ ch·ªëi</button>`;
    box.appendChild(div);
  });
}

function approve(index) {
  if (currentUser !== ADMIN) return;
  const pending = history.filter(h => h.status === "Ch·ªù duy·ªát").slice().reverse();
  const item = pending[index];
  const idx = history.findIndex(h => h.time === item.time && h.user === item.user && h.type === item.type);
  if (idx < 0) return;

  history[idx].status = "ƒê√£ duy·ªát";

  if (item.amount >= 10000 && item.type !== "Khi·∫øu n·∫°i") {
    const pointAdd = Math.floor(item.amount / 10000);
    scores[item.from] = (scores[item.from] || 0) + pointAdd;
    localStorage.setItem("scores", JSON.stringify(scores));
    alert(`ƒê∆°n n·∫°p c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c duy·ªát. B·∫°n ƒë∆∞·ª£c +${pointAdd} ƒëi·ªÉm t√≠ch lu·ªπ. Li√™n h·ªá admin ƒë·ªÉ ƒë·ªïi qu√†.`);
  }

  localStorage.setItem("history", JSON.stringify(history));
  showHistory();
  showAdminList();
  updateUI();
}

function reject(index) {
  if (currentUser !== ADMIN) return;
  const pending = history.filter(h => h.status === "Ch·ªù duy·ªát").slice().reverse();
  const item = pending[index];
  const idx = history.findIndex(h => h.time === item.time && h.user === item.user && h.type === item.type);
  if (idx < 0) return;

  history[idx].status = "T·ª´ ch·ªëi";
  localStorage.setItem("history", JSON.stringify(history));
  showHistory();
  showAdminList();
}

function promptDeductPoints() {
  if (currentUser !== ADMIN) return;
  const player = prompt("Nh·∫≠p t√™n ng∆∞·ªùi ch∆°i mu·ªën tr·ª´ ƒëi·ªÉm:");
  if (!player) return;
  if (!scores[player]) {
    alert("Ng∆∞·ªùi ch∆°i n√†y kh√¥ng c√≥ ƒëi·ªÉm.");
    return;
  }
  const amount = prompt(`Ng∆∞·ªùi ch∆°i ${player} hi·ªán c√≥ ${scores[player]} ƒëi·ªÉm.\nNh·∫≠p s·ªë ƒëi·ªÉm mu·ªën tr·ª´:`);
  if (!amount || isNaN(amount) || amount <= 0) {
    alert("S·ªë ƒëi·ªÉm kh√¥ng h·ª£p l·ªá.");
    return;
  }
  const deduct = Math.min(scores[player], parseInt(amount));
  scores[player] -= deduct;
  localStorage.setItem("scores", JSON.stringify(scores));
  alert(`ƒê√£ tr·ª´ ${deduct} ƒëi·ªÉm c·ªßa ng∆∞·ªùi ch∆°i ${player}.`);
  updateUI();
}
</script>
